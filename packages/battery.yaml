###############################################################################
#   @user           :   tornado
#   original Github
#   https://github.com/skalavala/smarthome
#   @author         :   Mahasri Kalavala
#   @date           :   04/15/2017
#   @package        :   Batteries
#   @description    :   Status about various baterries (iphones, sensors...etc)
###############################################################################
homeassistant:
  customize:
    sensor.tornados_iphone_battery:
      hidden: True
    sensor.lizs_iphone_battery:
      hidden: True

    sensor.tornado_iphone_battery:
      friendly_name: tornados iPhone Battery
    sensor.liz_iphone_battery:
      friendly_name: lizs iPhone Battery
    sensor.nina_battery_level:
      friendly_name: Nina iPhone Battery
#################################################################
#                                                               #
#                           Group                               #
#                                                               #
#################################################################

group:
  people:
    name: People
    view: no
    entities:
      - sensor.james
      - sensor.james_castle_location
      - sensor.battery_james
      - sensor.tina
      - sensor.tina_castle_location
      - sensor.battery_tina
      - sensor.commute_to_work
      - sensor.commute_from_work
      - sensor.james_to_home
      - sensor.next_bus

  family:
    name: Family
    view: no
    entities:
      - device_tracker.tornado
      - device_tracker.lynx
      - device_tracker.nina
      - device_tracker.monkey
      - device_tracker.ferina

sensor:
  - platform: template
    sensors:
      nina_iphone_battery:
        unit_of_measurement: '%'
        entity_id: device_tracker.nina
        value_template: "{{ (states.device_tracker.nina.attributes|default).battery|default|int('unknown') }}"
        icon_template: >-
          {% set battery_level = states('sensor.nina_iphone_battery')|int('unknown') %}
          {% set battery_round = (battery_level|int / 10)|int * 10 %}
          {% if battery_level == 'unknown' %}
            mdi:battery-unknown
          {% else %}
            {% if battery_round >= 100 %}
              mdi:battery
            {% elif battery_round > 0 %}
              mdi:battery-{{ battery_round }}
            {% else %}
              mdi:battery-alert
            {% endif %}
          {% endif %}

  - platform: template
    sensors:
      liz_iphone_battery:
        unit_of_measurement: '%'
        entity_id: device_tracker.lynx
        value_template: "{{ (states.device_tracker.lynx.attributes|default).battery|default|int('unknown') }}"
        icon_template: >-
          {% set battery_level = states('sensor.liz_iphone_battery')|int('unknown') %}
          {% set battery_round = (battery_level|int / 10)|int * 10 %}
          {% if battery_level == 'unknown' %}
            mdi:battery-unknown
          {% else %}
            {% if battery_round >= 100 %}
              mdi:battery
            {% elif battery_round > 0 %}
              mdi:battery-{{ battery_round }}
            {% else %}
              mdi:battery-alert
            {% endif %}
          {% endif %}

  - platform: template
    sensors:
      tornado_iphone_battery:
        unit_of_measurement: '%'
        entity_id: device_tracker.tornado
        value_template: "{{ (states.device_tracker.tornado.attributes|default).battery|default|int('unknown') }}"
        icon_template: >-
          {% set battery_level = states('sensor.tornado_iphone_battery')|int('unknown') %}
          {% set battery_round = (battery_level|int / 10)|int * 10 %}
          {% if battery_level == 'unknown' %}
            mdi:battery-unknown
          {% else %}
            {% if battery_round >= 100 %}
              mdi:battery
            {% elif battery_round > 0 %}
              mdi:battery-{{ battery_round }}
            {% else %}
              mdi:battery-alert
            {% endif %}
          {% endif %}

  - platform: template
    sensors:
      battery_charlie:
        friendly_name: "Battery Charlie"
        value_template: "{{ states.device_tracker.tornado.attributes.battery|int }}"
        icon_template: >-
          {% if is_state('sensor.charlie_charging', 'Charging') %}
            mdi:battery-charging
          {% endif %}
        unit_of_measurement: "%"
        device_class: battery

      battery_liz:
        friendly_name: "Battery Liz"
        value_template: "{{ states.device_tracker.liz.attributes.battery|int }}"
        icon_template: >-
          {% if is_state('sensor.liz_charging', 'Charging') %}
            mdi:battery-charging
          {% endif %}
        unit_of_measurement: "%"
        device_class: battery



  - platform: template
    sensors:
      charlie:
        friendly_name: "Charlie"
        value_template: >-
          {% if is_state('device_tracker.tornado', 'home') %}
            Home
          {% else %}
            Away
          {% endif %}

  - platform: template
    sensors:
      liz:
        friendly_name: "Liz"
        value_template: >-
          {% if is_state('device_tracker.lynx', 'home') %}
            Home
          {% else %}
            Away
          {% endif %}
binary_sensor:
  - platform: template
    sensors:
      charlie_gps_status:
        friendly_name: Charlie GPS
        device_class: connectivity
        entity_id: device_tracker.tornado
        value_template: "{{ is_state('device_tracker.tornado', 'home') }}"
        icon_template: >-
          {% if is_state('device_tracker.tornado', 'Home') %}
            mdi:crosshairs-gps
          {% elif is_state('device_tracker.tornado', 'not_home') %}
            mdi:crosshairs-gps
          {% else %}
            mdi:alert
          {% endif %}

  - platform: template
    sensors:
      liz_gps_status:
        friendly_name: Liz GPS
        device_class: connectivity
        entity_id: device_tracker.lynx
        value_template: "{{ is_state('device_tracker.lynx', 'home') }}"
        icon_template: >-
          {% if is_state('device_tracker.lynx', 'Home') %}
            mdi:crosshairs-gps
          {% elif is_state('device_tracker.lynx', 'not_home') %}
            mdi:crosshairs-gps
          {% else %}
            mdi:alert
          {% endif %}

automation:
  - alias: Notify Low battery
    initial_state: True
    trigger:
      platform: numeric_state
      entity_id:
      - device_tracker.lynx
      - device_tracker.tornado
      - device_tracker.nina
      value_template: '{{ state.attributes.battery }}'
      below: 30
    action:
      - service: notify.ios_tornado
        data_template:
          value1: >
            {{ trigger.to_state.attributes.friendly_name }}'s phone battery is less than: {{ trigger.to_state.attributes.battery }}%.
          value2: ""


#  - alias: Alert Low Battery Level of Sensors
#    trigger:
#      platform: numeric_state
#      entity_id:
#      - sensor.upstairs_multisensor_battery
#      - sensor.downstairs_multisensor_battery
#      - sensor.single_car_garage_door_sensor_battery
#      - sensor.two_car_garage_door_sensor_battery
#      below: 20
#    action:
#      - service: script.notify_me
#        data_template:
#          value1: >
#            Action Required: {{ trigger.to_state.attributes.friendly_name }}'s battery is: {{ trigger.to_state.state }}%.
#          value2: ""
  - alias: 'Notify if any doors left open for 10 minutes'
    initial_state: True
    trigger:
      platform: state
      entity_id:
      - sensor.garage_door_status
      to: 'closed'
    #  for:
    #    minutes: 1
    action:
      - service: notify.ios_tornado
        data_template:
          value1: >
              The garage door was left open
  - alias: "Internet Speed Glow Connect Great"
    trigger:
      - platform: template
        value_template: "{{ states('sensor.speedtest_download')|float >= 10 }}"
    action:
      - service: shell_command.green

  - alias: "Internet Speed Glow Connect Poor"
    trigger:
      - platform: template
        value_template: "{{ states('sensor.speedtest_download')|float < 10 }}"
    action:
      - service: shell_command.red
